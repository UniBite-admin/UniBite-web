<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset Password ¬∑ UniBite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <!-- üîß Set these to your Supabase project -->
  <meta name="supabase-url" content="YOUR_SUPABASE_URL" />
  <meta name="supabase-anon-key" content="YOUR_SUPABASE_ANON_KEY" />

  <style>
    :root { --bg:#0b0c10; --card:#111217; --txt:#e8e8e8; --muted:#a6adbb; --pri:#7c4dff; --ok:#22c55e; --err:#ef4444; }
    html,body { height:100%; }
    body {
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--txt);
      background:linear-gradient(180deg,#0e0f14 0%,#0b0c10 100%);
      display:grid; place-items:center;
    }
    .card {
      width:min(520px,92vw); background:var(--card); border:1px solid #22242c; border-radius:14px; padding:28px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1 { font-size:1.25rem; margin:0 0 8px; }
    p  { margin:.4rem 0 .9rem; color:var(--muted); }
    label { display:block; font-size:.9rem; margin:.5rem 0 .35rem; color:#cfd5e1; }
    input[type=password] {
      width:100%; padding:12px 13px; border-radius:10px; border:1px solid #2a2f3a; background:#0f1117; color:#e7eaf3;
      outline:none; transition:border-color .2s;
    }
    input:focus { border-color:#3e4bff; }
    .row { display:flex; gap:12px; align-items:center; }
    .hint { font-size:.82rem; color:var(--muted); margin-top:8px; }
    .error { color:var(--err); font-size:.9rem; margin-top:8px; display:none; }
    .success { color:var(--ok); font-size:.95rem; margin-top:8px; display:none; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      background:var(--pri); color:white; border:none; border-radius:10px; padding:12px 16px; font-weight:600;
      cursor:pointer; width:100%; margin-top:12px; transition:filter .2s, opacity .2s;
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .footer { margin-top:14px; font-size:.85rem; color:var(--muted); }
    .shield { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .strength { font-size:.82rem; margin-top:6px; color:#cfd5e1; }
    .toggle { white-space:nowrap; display:flex; align-items:center; gap:8px; color:#cfd5e1; }
    .hide { display:none; }
    .note { font-size:.85rem; color:#cfd5e1; margin-top:10px; }
    code.inline { background:#0b0f19; padding:2px 6px; border-radius:6px; border:1px solid #1f2430; color:#d1d7e6; }
  </style>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.jsead>
<body>
  <main class="card">
    
  </script>

    <h1>Reset your password</h1>
    <p id="intro">We‚Äôre verifying your reset link. One moment‚Ä¶</p>

    <form id="resetForm" class="hide" autocomplete="off" novalidate>
      <label for="password">New password</label>
      <div class="row">
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Enter new password"
          minlength="8"
          required
          aria-required="true"
          autocomplete="new-password"
        />
        <label class="toggle" for="togglePw"><input type="checkbox" id="togglePw" /> Show</label>
      </div>

      <div class="strength" id="pwStrength">
        <span class="shield" id="strengthDot" style="background:#6b7280"></span>
        <span id="strengthText">Strength: ‚Äî</span>
      </div>

      <label for="confirm">Confirm new password</label>
      <input
        type="password"
        id="confirm"
        name="confirm"
        placeholder="Re-enter new password"
        minlength="8"
        required
        aria-required="true"
        autocomplete="new-password"
      />

      <div class="hint">Use at least 8 characters, with upper/lowercase, a number, and a symbol.</div>

      <div class="error" id="errorBox"></div>
      <div class="success" id="successBox"></div>

      <button class="btn" id="submitBtn" type="submit" disabled>
        <span id="btnText">Update password</span>
        <span id="btnSpinner" class="hide" aria-hidden="true">‚è≥</span>
      </button>

      <div class="footer" id="footerNote"></div>
      <div class="note">Debug: add <code class="inline">?DEBUG=1</code> to the URL to log diagnostics to the console.</div>
    </form>
  </main>

  <script>
    'use strict';

    window.addEventListener('DOMContentLoaded', () => {
      // --- Config: read from <meta> ---
      const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content?.trim();
      const SUPABASE_KEY = document.querySelector('meta[name="supabase-anon-key"]')?.content?.trim();

      // --- DOM refs ---
      const $ = (s) => document.querySelector(s);
      const form = $('#resetForm');
      const intro = $('#intro');
      const footerNote = $('#footerNote');
      const errorBox = $('#errorBox');
      const successBox = $('#successBox');
      const submitBtn = $('#submitBtn');
      const btnText = $('#btnText');
      const btnSpinner = $('#btnSpinner');
      const pw = $('#password');
      const cf = $('#confirm');
      const togglePw = $('#togglePw');
      const strengthText = $('#strengthText');
      const strengthDot = $('#strengthDot');

      const DEBUG = /[?&]DEBUG=1\b/i.test(window.location.search);
      const log = (...a) => { if (DEBUG) console.log('[reset-password]', ...a); };

      // --- Guards ---
      if (!window.supabase?.createClient) {
        console.error('Supabase library failed to load.');
        intro.textContent = 'Could not load authentication library. Please refresh and try again.';
        return;
      }
      if (!SUPABASE_URL || !SUPABASE_KEY) {
        console.error('Missing Supabase configuration.');
        intro.textContent = 'Setup error: missing Supabase configuration.';
        return;
      }

      // Use implicit flow explicitly (default for JS).
      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: { flowType: 'implicit', detectSessionInUrl: false }
      });

      // --- Helpers ---
      const getHashParams = () => {
        const raw = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
        return Object.fromEntries(new URLSearchParams(raw));
      };

      const clearHash = () => {
        if (window.location.hash) {
          history.replaceState(null, document.title, window.location.pathname + window.location.search);
        }
      };

      const setLoading = (state) => {
        submitBtn.disabled = state;
        btnSpinner.classList.toggle('hide', !state);
        btnText.textContent = state ? 'Updating‚Ä¶' : 'Update password';
      };

      const show = (el, ok = true) => { el.style.display = ok ? 'block' : 'none'; };

      const validate = () => {
        errorBox.textContent = '';
        const p = pw.value.trim();
        const c = cf.value.trim();
        const okLen = p.length >= 8;
        const upper = /[A-Z]/.test(p);
        const lower = /[a-z]/.test(p);
        const digit = /\d/.test(p);
        const sym   = /[^A-Za-z0-9]/.test(p);

        const score = [okLen, upper, lower, digit, sym].filter(Boolean).length;
        const colors = ['#6b7280', '#ef4444', '#f59e0b', '#22c55e', '#22c55e', '#16a34a'];
        const labels = ['‚Äî', 'Very weak', 'Weak', 'Okay', 'Good', 'Strong'];
        strengthDot.style.background = colors[score];
        strengthText.textContent = `Strength: ${labels[score]}`;

        submitBtn.disabled = !(okLen && upper && lower && digit && sym && p === c);
      };

      pw.addEventListener('input', validate);
      cf.addEventListener('input', validate);
      togglePw.addEventListener('change', () => {
        const t = togglePw.checked ? 'text' : 'password';
        pw.type = t; cf.type = t;
      });

      // --- Init flow (implicit only) ---
      (async function init() {
        try {
          intro.textContent = 'We‚Äôre verifying your reset link. One moment‚Ä¶';

          const params = getHashParams();
          log('hash params', params);

          // Expect: #access_token, #refresh_token, #type=recovery
          const access_token  = params['access_token'];
          const refresh_token = params['refresh_token'];
          const type          = params['type'];

          if (type === 'recovery' && access_token && refresh_token) {
            const { error: sessErr } = await client.auth.setSession({ access_token, refresh_token });
            if (sessErr) throw sessErr;
            clearHash(); // remove tokens from URL
          }

          const { data: sessionData, error: sErr } = await client.auth.getSession();
          if (sErr) throw sErr;

          if (sessionData?.session) {
            intro.textContent = 'Enter your new password below.';
            form.classList.remove('hide');
            validate();
          } else {
            // Not opened via the proper implicit reset link
            intro.textContent = 'Open this page from the password reset link we emailed you.';
            footerNote.textContent = 'Tip: Trigger the reset from this browser and use the link that includes #access_token and #refresh_token.';
          }
        } catch (e) {
          console.error(e);
          intro.textContent = 'We couldn‚Äôt verify your reset link.';
          errorBox.textContent = e?.message || 'Unknown error while verifying the link.';
          show(errorBox, true);
        }
      })();

      // --- Submit: update password ---
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        errorBox.textContent = '';
        successBox.textContent = '';
        setLoading(true);

        try {
          const newPassword = pw.value.trim();
          const { error } = await client.auth.updateUser({ password: newPassword });
          if (error) throw error;

          show(successBox, true);
          successBox.textContent = '‚úÖ Password updated successfully. You can now sign in with your new password.';
          form.querySelectorAll('input').forEach(i => i.disabled = true);
          submitBtn.disabled = true;
        } catch (e) {
          console.error(e);
          show(errorBox, true);
          errorBox.textContent = e?.message || 'Password update failed. Please try again.';
        } finally {
          setLoading(false);
        }
      });
    });
  </script>
</body>
</html>
