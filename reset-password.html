<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset Password ¬∑ UniBite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <!-- üîß Replace with your Supabase project values -->
  <meta name="supabase-url" content="https://qxcofmbryadnwknjgflh.supabase.co" />
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4Y29mbWJyeWFkbndrbmpnZmxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDAxNjUsImV4cCI6MjA3MTgxNjE2NX0.qf7gsas6C7IUdwcXDV8642UMx67Afv54bizzQQ4o3rk" />

  <style>
    :root { --bg:#7f9ce0; --card:#171b2b; --txt:#e8e8e8; --muted:#a6adbb; --pri:#7f9ce0; --ok:#22c55e; --err:#ef4444; }
    html,body { height:100%; }
    body {
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--txt); background:linear-gradient(180deg,#7f9ce0 0%,#7f9ce0 100%);
      display:grid; place-items:center;
    }
    .card { width:min(560px,92vw); background:var(--card); border:1px solid #22242c; border-radius:14px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size:1.25rem; margin:0 0 8px; }
    p  { margin:.4rem 0 .9rem; color:var(--muted); }
    label { display:block; font-size:.9rem; margin:.5rem 0 .35rem; color:#cfd5e1; }
    input[type=password], input[type=email] {
      width:100%; padding:12px 13px; border-radius:10px; border:1px solid #2a2f3a; background:#0f1117; color:#e7eaf3;
      outline:none; transition:border-color .2s;
    }
    input:focus { border-color:#3e4bff; }
    .row { display:flex; gap:12px; align-items:center; }
    .hint { font-size:.82rem; color:var(--muted); margin-top:8px; }
    .error { color:var(--err); font-size:.9rem; margin-top:8px; display:none; white-space:pre-wrap; }
    .success { color:var(--ok); font-size:.95rem; margin-top:8px; display:none; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      background:var(--pri); color:white; border:none; border-radius:10px; padding:12px 16px; font-weight:600;
      cursor:pointer; width:100%; margin-top:12px; transition:filter .2s, opacity .2s;
    }
    .btn.secondary { background:#2a2f3a; color:#e7eaf3; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .footer { margin-top:14px; font-size:.85rem; color:var(--muted); }
    .shield { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .strength { font-size:.82rem; margin-top:6px; color:#cfd5e1; }
    .toggle { white-space:nowrap; display:flex; align-items:center; gap:8px; color:#cfd5e1; }
    .hide { display:none; }
    .note { font-size:.85rem; color:#cfd5e1; margin-top:10px; }
    code.inline { background:#0b0f19; padding:2px 6px; border-radius:6px; border:1px solid #1f2430; color:#d1d7e6; }
    .section { padding:14px; border:1px dashed #2a2f3a; border-radius:10px; margin-top:14px; }
    /* Inactivate the rest of the UI after success while keeping success message readable */
    .inert-overlay *:not(#successBox):not(#successBox *) {
      pointer-events: none !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      opacity: 0.7;
    }
  </style>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
</head>
<body>
  <main class="card" id="cardRoot">
    <h1>Reset your password</h1>
    <p id="intro">We‚Äôre verifying your reset link. One moment‚Ä¶</p>

    <!-- Reset form -->
    <form id="resetForm" class="hide" autocomplete="off" novalidate>
      <label for="password">New password</label>
      <div class="row">
        <input type="password" id="password" name="password" placeholder="Enter new password" minlength="8" required aria-required="true" autocomplete="new-password" />
        <label class="toggle" for="togglePw"><input type="checkbox" id="togglePw" /> Show</label>
      </div>
      <div class="strength" id="pwStrength"><span class="shield" id="strengthDot" style="background:#6b7280"></span><span id="strengthText">Strength: ‚Äî</span></div>

      <label for="confirm">Confirm new password</label>
      <input type="password" id="confirm" name="confirm" placeholder="Re-enter new password" minlength="8" required aria-required="true" autocomplete="new-password" />

      <div class="hint">Use at least 8 characters, with upper/lowercase, a number, and a symbol.</div>

      <div class="error" id="errorBox"></div>
      <div class="success" id="successBox"></div>

      <button class="btn" id="submitBtn" type="submit" disabled>
        <span id="btnText">Update password</span>
        <span id="btnSpinner" class="hide" aria-hidden="true">‚è≥</span>
      </button>

      <div class="footer" id="footerNote"></div>
      <div class="note">Debug: add <code class="inline">?DEBUG=1</code> to the URL to log diagnostics.</div>
    </form>

    <!-- PKCE conversion section (shown when ?code= is present and no verifier) -->
    <section id="pkceHelper" class="section hide" aria-live="polite">
      <h2 style="font-size:1rem; margin:.2rem 0 .6rem;">Can‚Äôt verify this link</h2>
      <p style="margin-top:0">This reset link uses a PKCE code that can‚Äôt be exchanged here. Re‚Äësend a reset email from this browser to continue.</p>
      <form id="resendForm" autocomplete="off">
        <label for="resendEmail">Email address</label>
        <input id="resendEmail" type="email" placeholder="you@example.com" required />
        <div class="error" id="resendError"></div>
        <div class="success" id="resendSuccess"></div>
        <div class="row" style="margin-top:10px">
          <button type="submit" id="resendBtn" class="btn">Send new reset email</button>
          <button type="button" id="retryBtn" class="btn secondary">Retry link</button>
        </div>
        <p class="hint">The new email will redirect back to this same page with a secure token (implicit flow).</p>
      </form>
    </section>
  </main>

  <script>
    'use strict';

    window.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content?.trim();
      const SUPABASE_KEY = document.querySelector('meta[name="supabase-anon-key"]')?.content?.trim();

      const $ = (s) => document.querySelector(s);
      const cardRoot = $('#cardRoot');
      const form = $('#resetForm');
      const intro = $('#intro');
      const footerNote = $('#footerNote');
      const errorBox = $('#errorBox');
      const successBox = $('#successBox');
      const submitBtn = $('#submitBtn');
      const btnText = $('#btnText');
      const btnSpinner = $('#btnSpinner');
      const pw = $('#password');
      const cf = $('#confirm');
      const togglePw = $('#togglePw');
      const strengthText = $('#strengthText');
      const strengthDot = $('#strengthDot');

      const pkceHelper = $('#pkceHelper');
      const resendForm = $('#resendForm');
      const resendEmail = $('#resendEmail');
      const resendBtn = $('#resendBtn');
      const resendError = $('#resendError');
      const resendSuccess = $('#resendSuccess');
      const retryBtn = $('#retryBtn');

      const DEBUG = /[?&]DEBUG=1\b/i.test(window.location.search);
      const log = (...a) => { if (DEBUG) console.log('[reset-password]', ...a); };

      if (!window.supabase?.createClient) {
        intro.textContent = 'Could not load authentication library. Please refresh and try again.';
        return;
      }
      if (!SUPABASE_URL || !SUPABASE_KEY) {
        intro.textContent = 'Setup error: missing Supabase configuration.';
        return;
      }

      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: { flowType: 'implicit', detectSessionInUrl: false }
      });

      const getParams = () => {
        const search = new URLSearchParams(window.location.search);
        const hash = new URLSearchParams(window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash);
        const map = new Map();
        for (const [k,v] of search) map.set(k.toLowerCase(), v);
        for (const [k,v] of hash)   map.set(k.toLowerCase(), v);
        return map;
      };

      const clearSensitive = () => {
        const url = new URL(window.location.href);
        url.hash = '';
        const keep = new URLSearchParams(url.search);
        ['code','access_token','refresh_token','token','token_hash','type','error','error_code','error_description']
          .forEach(k => keep.delete(k));
        url.search = keep.toString() ? '?' + keep.toString() : '';
        history.replaceState(null, document.title, url.pathname + url.search);
      };

      const setLoading = (state) => {
        submitBtn.disabled = state;
        btnSpinner.classList.toggle('hide', !state);
        btnText.textContent = state ? 'Updating‚Ä¶' : 'Update password';
      };
      const show = (el, ok = true) => { el.classList.toggle('hide', !ok); };

      const validate = () => {
        errorBox.textContent = '';
        const p = pw.value.trim(); const c = cf.value.trim();
        const okLen = p.length >= 8, upper = /[A-Z]/.test(p), lower = /[a-z]/.test(p), digit = /\d/.test(p), sym = /[^A-Za-z0-9]/.test(p);
        const score = [okLen, upper, lower, digit, sym].filter(Boolean).length;
        const colors = ['#6b7280','#ef4444','#f59e0b','#22c55e','#22c55e','#16a34a'];
        const labels = ['‚Äî','Very weak','Weak','Okay','Good','Strong'];
        strengthDot.style.background = colors[score];
        strengthText.textContent = `Strength: ${labels[score]}`;
        submitBtn.disabled = !(okLen && upper && lower && digit && sym && p === c);
      };

      pw.addEventListener('input', validate);
      cf.addEventListener('input', validate);
      togglePw.addEventListener('change', () => { const t = togglePw.checked ? 'text' : 'password'; pw.type = t; cf.type = t; });

      (async function init(){
        try {
          intro.textContent = 'We‚Äôre verifying your reset link. One moment‚Ä¶';
          const P = getParams();
          log('params', Object.fromEntries(P));

          const err = P.get('error');
          const err_desc = P.get('error_description');
          const err_code = P.get('error_code');
          if (err) throw new Error(err_desc || `${err}${err_code ? ` (${err_code})` : ''}`);

          const type = P.get('type');
          const access_token = P.get('access_token');
          const refresh_token = P.get('refresh_token');

          // 1) Implicit flow: #access_token + #refresh_token + type=recovery
          if (type === 'recovery' && access_token && refresh_token) {
            log('Setting session from implicit tokens‚Ä¶');
            const { error } = await client.auth.setSession({ access_token, refresh_token });
            if (error) throw error;
            clearSensitive();
          }

          // 2) OTP fallback: token_hash (or token not starting with pkce_)
          let { data: s1 } = await client.auth.getSession();
          let sessionOk = !!s1?.session;
          if (!sessionOk) {
            const token_hash = P.get('token_hash');
            const token = P.get('token');
            const looksPkce = token && /^pkce_/i.test(token);
            if (type === 'recovery' && (token_hash || (token && !looksPkce))) {
              log('Verifying recovery via verifyOtp‚Ä¶');
              const { error } = await client.auth.verifyOtp({ type: 'recovery', token_hash: token_hash || token });
              if (error) throw error;
              clearSensitive();
              const { data: s2 } = await client.auth.getSession();
              sessionOk = !!s2?.session;
            }
          }

          // 3) If a PKCE code is present, DO NOT exchange it here. Show helper instead.
          if (!sessionOk) {
            const code = P.get('code');
            if (code) {
              log('PKCE code detected; showing resend helper instead of exchanging.');
              show(pkceHelper, true);
              intro.textContent = 'We couldn‚Äôt verify this specific link.';
            }
          }

          if (sessionOk) {
            intro.textContent = 'Enter your new password below.';
            show(form, true);
            validate();
            show(pkceHelper, false);
          } else if (!P.get('code')) {
            intro.textContent = 'Open this page from the password reset link we emailed you.';
            footerNote.textContent = 'Tip: Trigger the reset from this browser and open the link that includes #access_token and #refresh_token.';
          }
        } catch (e) {
          console.error(e);
          intro.textContent = 'We couldn‚Äôt verify your reset link.';
          errorBox.textContent = (e && e.message) ? e.message : 'Unknown error while verifying the link.';
          errorBox.style.display = 'block';
        }
      })();

      // Submit: update password
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        errorBox.textContent = '';
        successBox.textContent = '';
        setLoading(true);
        try {
          const newPassword = pw.value.trim();
          const { error } = await client.auth.updateUser({ password: newPassword });
          if (error) throw error;

          // ‚úÖ Show final message requested by Alper
          successBox.textContent = 'Password updated successfully. You can now close this window and sign in with your new password.';
          successBox.style.display = 'block';

          // Make everything else inactive
          // 1) Disable all interactive controls
          document.querySelectorAll('input, button, a, select, textarea').forEach(el => {
            try { if ('disabled' in el) el.disabled = true; } catch(_) {}
            el.setAttribute('tabindex','-1');
            el.setAttribute('aria-disabled','true');
          });
          // 2) Add inert attribute to main sections (where supported)
          form.setAttribute('inert','');
          pkceHelper?.setAttribute('inert','');
          // 3) Add overlay class to block pointer events but leave the success message readable
          cardRoot.classList.add('inert-overlay');

        } catch (e) {
          console.error(e);
          errorBox.textContent = (e && e.message) ? e.message : 'Password update failed. Please try again.';
          errorBox.style.display = 'block';
        } finally {
          setLoading(false);
        }
      });

      // PKCE helper: resend implicit flow email
      resendForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        resendError.style.display = 'none';
        resendSuccess.style.display = 'none';
        resendBtn.disabled = true;
        try {
          const addr = resendEmail.value.trim();
          if (!addr) throw new Error('Please enter your email.');
          const redirectTo = window.location.origin + window.location.pathname; // come back to same page
          const { error } = await client.auth.resetPasswordForEmail(addr, { redirectTo });
          if (error) throw error;
          resendSuccess.textContent = '‚úÖ Email sent. Open the new link on this device to continue.';
          resendSuccess.style.display = 'block';
        } catch (e) {
          resendError.textContent = (e && e.message) ? e.message : 'Could not send the reset email.';
          resendError.style.display = 'block';
        } finally {
          resendBtn.disabled = false;
        }
      });

      // Retry current link (useful if user switched browsers)
      retryBtn.addEventListener('click', () => { window.location.reload(); });
    });
  </script>
</body>
</html>

