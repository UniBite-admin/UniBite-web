<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset Password · UniBite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="supabase-url" content="https://qxcofmbryadnwknjgflh.supabase.co" />
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4Y29mbWJyeWFkbndrbmpnZmxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDAxNjUsImV4cCI6MjA3MTgxNjE2NX0.qf7gsas6C7IUdwcXDV8642UMx67Afv54bizzQQ4o3rk" />
  <style>
    :root { --bg:#0b0c10; --card:#111217; --txt:#e8e8e8; --muted:#a6adbb; --pri:#7c4dff; --ok:#22c55e; --err:#ef4444; }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--txt); background:linear-gradient(180deg,#0e0f14 0%,#0b0c10 100%); display:grid; place-items:center; }
    .card { width:min(520px,92vw); background:var(--card); border:1px solid #22242c; border-radius:14px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size:1.25rem; margin:0 0 8px; }
    p  { margin:.4rem 0 .9rem; color:var(--muted); }
    label { display:block; font-size:.9rem; margin:.5rem 0 .35rem; color:#cfd5e1; }
    input[type=password] { width:100%; padding:12px 13px; border-radius:10px; border:1px solid #2a2f3a; background:#0f1117; color:#e7eaf3; outline:none; transition:border-color .2s; }
    input:focus { border-color:#3e4bff; }
    .row { display:flex; gap:12px; align-items:center; }
    .hint { font-size:.82rem; color:var(--muted); margin-top:8px; }
    .error { color:var(--err); font-size:.9rem; margin-top:8px; display:none; white-space:pre-wrap; }
    .success { color:var(--ok); font-size:.95rem; margin-top:8px; display:none; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; background:var(--pri); color:white; border:none; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; width:100%; margin-top:12px; transition:filter .2s, opacity .2s; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .footer { margin-top:14px; font-size:.85rem; color:var(--muted); }
    .shield { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .strength { font-size:.82rem; margin-top:6px; color:#cfd5e1; }
    .toggle { white-space:nowrap; display:flex; align-items:center; gap:8px; color:#cfd5e1; }
    .hide { display:none; }
    .note { font-size:.85rem; color:#cfd5e1; margin-top:10px; }
    code.inline { background:#0b0f19; padding:2px 6px; border-radius:6px; border:1px solid #1f2430; color:#d1d7e6; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
</head>
<body>
  <main class="card">
    <h1>Reset your password</h1>
    <p id="intro">We’re verifying your reset link. One moment…</p>
    <form id="resetForm" class="hide" autocomplete="off" novalidate>
      <label for="password">New password</label>
      <div class="row">
        <input type="password" id="password" name="password" placeholder="Enter new password" minlength="8" required aria-required="true" autocomplete="new-password" />
        <label class="toggle" for="togglePw"><input type="checkbox" id="togglePw" /> Show</label>
      </div>
      <div class="strength" id="pwStrength"><span class="shield" id="strengthDot" style="background:#6b7280"></span><span id="strengthText">Strength: —</span></div>
      <label for="confirm">Confirm new password</label>
      <input type="password" id="confirm" name="confirm" placeholder="Re-enter new password" minlength="8" required aria-required="true" autocomplete="new-password" />
      <div class="hint">Use at least 8 characters, with upper/lowercase, a number, and a symbol.</div>
      <div class="error" id="errorBox"></div>
      <div class="success" id="successBox"></div>
      <button class="btn" id="submitBtn" type="submit" disabled>
        <span id="btnText">Update password</span>
        <span id="btnSpinner" class="hide" aria-hidden="true">⏳</span>
      </button>
      <div class="footer" id="footerNote"></div>
      <div class="note">Debug: add <code class="inline">?DEBUG=1</code> to the URL to log diagnostics.</div>
    </form>
  </main>
  <script>
    'use strict';
    window.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]').content.trim();
      const SUPABASE_KEY = document.querySelector('meta[name="supabase-anon-key"]').content.trim();
      const $ = (s) => document.querySelector(s);
      const form = $('#resetForm'), intro = $('#intro'), footerNote = $('#footerNote');
      const errorBox = $('#errorBox'), successBox = $('#successBox');
      const submitBtn = $('#submitBtn'), btnText = $('#btnText'), btnSpinner = $('#btnSpinner');
      const pw = $('#password'), cf = $('#confirm'), togglePw = $('#togglePw');
      const strengthText = $('#strengthText'), strengthDot = $('#strengthDot');
      const DEBUG = /[?&]DEBUG=1\b/i.test(window.location.search);
      const log = (...a) => { if (DEBUG) console.log('[reset-password]', ...a); };
      if (!window.supabase?.createClient) { intro.textContent = 'Could not load authentication library. Please refresh and try again.'; return; }
      if (!SUPABASE_URL || !SUPABASE_KEY) { intro.textContent = 'Setup error: missing Supabase configuration.'; return; }
      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { flowType: 'implicit', detectSessionInUrl: false } });
      const getParams = () => { const s=new URLSearchParams(window.location.search); const h=new URLSearchParams(window.location.hash.startsWith('#')?window.location.hash.slice(1):window.location.hash); const m=new Map(); for(const [k,v] of s)m.set(k.toLowerCase(),v); for(const [k,v] of h)m.set(k.toLowerCase(),v); return m; };
      const clearSensitive = () => { const u=new URL(window.location.href); u.hash=''; const keep=new URLSearchParams(u.search); ['code','access_token','refresh_token','token','token_hash','type','error','error_code','error_description'].forEach(k=>keep.delete(k)); u.search=keep.toString()?('?'+keep.toString()):''; history.replaceState(null, document.title, u.pathname+u.search); };
      const setLoading = (b) => { submitBtn.disabled=b; btnSpinner.classList.toggle('hide', !b); btnText.textContent=b?'Updating…':'Update password'; };
      const show = (el, ok=true) => { el.style.display = ok ? 'block' : 'none'; };
      const validate = () => { errorBox.textContent=''; const p=pw.value.trim(), c=cf.value.trim(); const okLen=p.length>=8, upper=/[A-Z]/.test(p), lower=/[a-z]/.test(p), digit=/\d/.test(p), sym=/[^A-Za-z0-9]/.test(p); const score=[okLen,upper,lower,digit,sym].filter(Boolean).length; const colors=['#6b7280','#ef4444','#f59e0b','#22c55e','#22c55e','#16a34a']; const labels=['—','Very weak','Weak','Okay','Good','Strong']; strengthDot.style.background=colors[score]; strengthText.textContent=`Strength: ${labels[score]}`; submitBtn.disabled=!(okLen&&upper&&lower&&digit&&sym&&p===c); };
      pw.addEventListener('input', validate); cf.addEventListener('input', validate); togglePw.addEventListener('change', ()=>{ const t=togglePw.checked?'text':'password'; pw.type=t; cf.type=t; });
      (async function init(){
        try{
          intro.textContent='We’re verifying your reset link. One moment…';
          const P=getParams(); log('params', Object.fromEntries(P));
          const err=P.get('error'); const desc=P.get('error_description'); const code=P.get('error_code'); if(err) throw new Error(desc||`${err}${code?` (${code})`:''}`);
          const type=P.get('type'); const at=P.get('access_token'); const rt=P.get('refresh_token');
          if(type==='recovery' && at && rt){ const { error } = await client.auth.setSession({ access_token:at, refresh_token:rt }); if(error) throw error; clearSensitive(); }
          let { data:s1 } = await client.auth.getSession(); let sessionOk=!!s1?.session;
          if(!sessionOk){ const th=P.get('token_hash'); const t=P.get('token'); const looksPkce=t && /^pkce_/i.test(t); if(type==='recovery' && (th || (t && !looksPkce))){ const { error } = await client.auth.verifyOtp({ type:'recovery', token_hash: th || t }); if(error) throw error; clearSensitive(); let { data:s2 }=await client.auth.getSession(); sessionOk=!!s2?.session; }}
          if(!sessionOk){ const codeParam=P.get('code'); if(codeParam){ const { error } = await client.auth.exchangeCodeForSession(codeParam); if(error) throw error; clearSensitive(); let { data:s3 }=await client.auth.getSession(); sessionOk=!!s3?.session; }}
          if(sessionOk){ intro.textContent='Enter your new password below.'; form.classList.remove('hide'); validate(); }
          else{ intro.textContent='Open this page from the password reset link we emailed you.'; footerNote.textContent='Tip: Trigger the reset from this browser and open the link that includes #access_token and #refresh_token.'; }
        }catch(e){ console.error(e); intro.textContent='We couldn’t verify your reset link.'; errorBox.textContent=(e&&e.message)?e.message:'Unknown error while verifying the link.'; show(errorBox,true); }
      })();
      form.addEventListener('submit', async (ev)=>{ ev.preventDefault(); errorBox.textContent=''; successBox.textContent=''; setLoading(true); try{ const newPassword=pw.value.trim(); const { error } = await client.auth.updateUser({ password:newPassword }); if(error) throw error; show(successBox,true); successBox.textContent='✅ Password updated successfully. You can now sign in with your new password.'; form.querySelectorAll('input').forEach(i=>i.disabled=true); submitBtn.disabled=true; }catch(e){ console.error(e); show(errorBox,true); errorBox.textContent=(e&&e.message)?e.message:'Password update failed. Please try again.'; } finally{ setLoading(false); } });
    });
  </script>
</body>
</html>
